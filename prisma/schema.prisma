generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

////////////////////////////
/////  Modèles Auth   //////
////////////////////////////
model User {
  id            String   @id @default(cuid())
  name          String
  email         String   @unique
  emailVerified Boolean  @default(false)
  image         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Auth relations
  sessions Session[]
  accounts Account[]

  // Business relations
  ownedTeams Team[]     @relation("TeamOwner")
  userTeams  UserTeam[]

  createdItems       Item[]       @relation("ItemCreator")
  createdEquipements Equipement[] @relation("EquipementCreator")
  createdLots        Lot[]        @relation("LotCreator")

  createdLotEvents      LotEvent[]      @relation("LotEventCreator")
  createdCalendarEvents CalendarEvent[] @relation("CalendarEventCreator")

  @@map("users")
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("sessions")
}

model Account {
  id         String @id @default(cuid())
  accountId  String
  providerId String
  userId     String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@unique([providerId, accountId])
  @@index([userId])
  @@map("accounts")
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier, value])
  @@map("verifications")
}

//////////////////
/////   Dev  /////
//////////////////
model Item {
  id          String  @id @default(cuid())
  order       Int     @default(0)
  name        String
  description String?
  parentId    String?

  // Relations
  parent   Item?  @relation("ItemHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children Item[] @relation("ItemHierarchy")

  // Metadata
  createdById String
  createdBy   User     @relation("ItemCreator", fields: [createdById], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([parentId])
  @@index([createdById])
  @@map("items")
}

//////////////////////
//////   Teams   /////
//////////////////////
model Team {
  id       String  @id @default(cuid())
  order    Int     @default(0)
  name     String
  type     String  @default("TEAM") // ORGANIZATION | TEAM | FARM
  parentId String?

  // Relations
  parent    Team?      @relation("TeamHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children  Team[]     @relation("TeamHierarchy")
  members   UserTeam[]
  batiments Batiment[]

  // 1-1 with Setting
  setting Setting?

  // Calendar
  calendarEvents CalendarEvent[]

  // Metadata
  ownerId   String
  owner     User     @relation("TeamOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([parentId])
  @@index([ownerId])
  @@index([type])
  @@map("teams")
}

model UserTeam {
  id     String @id @default(cuid())
  teamId String
  userId String
  role   String @default("member") // owner|admin|member|viewer

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  joinedAt DateTime @default(now())

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
  @@map("user_teams")
}

////////////////////////
//////   Farming   /////
////////////////////////
model Batiment {
  id       String @id @default(cuid())
  order    Int    @default(0)
  name     String
  surface  Float
  capacity Int
  teamId   String

  // Relations
  team        Team         @relation(fields: [teamId], references: [id], onDelete: Cascade)
  lots        Lot[]
  equipements Equipement[]

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teamId])
  @@map("batiments")
}

model Equipement {
  id                  String  @id @default(cuid())
  order               Int     @default(0)
  name                String
  description         String?
  legalNorms          String?
  maintenanceSchedule String?
  batimentId          String

  // Relations
  batiment Batiment @relation(fields: [batimentId], references: [id], onDelete: Cascade)

  // Metadata
  createdById String
  createdBy   User     @relation("EquipementCreator", fields: [createdById], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([batimentId])
  @@index([createdById])
  @@map("equipements")
}

////////////////////////////////////////
//////   Breeding plannification   /////
///////////////////////////////////////

model LifeCircle {
  id    String  @id @default(cuid())
  order Int     @default(0)
  type  String // pondeuse | chair
  phase Phase[] //Démarrage, Croissance, Pré-ponte, Mise en ponte, Monté en ponte, Pic de ponte, Plateau de ponte, Fin de cycle
}

model Phase {
  id            String           @id @default(cuid())
  order         Int              @default(0)
  name          String
  weekStart     DateTime
  weekEnd       DateTime
  events        Event[] // objectif de poid, consomation de Gr, ponte
  task          Tasks[] // prophylavie, intervention
  breedingParam BreedingParams[] // reglage environement
  lifeCircleId  String
  lifeCircle    LifeCircle       @relation(fields: [lifeCircleId], references: [id], onDelete: Cascade)
}

model Event {
  id          String   @id @default(cuid())
  order       Int      @default(0)
  name        String
  day         DateTime
  Cheptel     Int // % restant de poule calculé dans l'app 
  weightGrams Int // Objectif de poid en Gr,
  feedAmount  Json //Alimtype et FeedQuantity
  nbEggs      Int // ex ; 0.88 
  nbeggS      Int // en % pourcalcul du nombre d'oeuf dans l'app
  nbeggM      Int // en % pourcalcul du nombre d'oeuf dans l'app
  nbeggL      Int // en % pourcalcul du nombre d'oeuf dans l'app
  nbeggXL     Int // en % pourcalcul du nombre d'oeuf dans l'app

  phaseId String?
  phase   Phase?  @relation(fields: [phaseId], references: [id])
}

model Tasks {
  id       String   @id @default(cuid())
  order    Int      @default(0)
  name     String
  day      DateTime
  taskList String[]

  phaseId String?
  phase   Phase?  @relation(fields: [phaseId], references: [id])
}

model BreedingParams {
  id             String   @id @default(cuid())
  order          Int      @default(0)
  day            DateTime
  temperature    String // °C
  humidity       String // 40%,
  lightHours     String // 15 h,
  lightIntensity String // 25 mix,
  phase          Phase?   @relation(fields: [phaseId], references: [id])
  phaseId        String?
}

///////////////////////
/////   Breeding   ////
///////////////////////

model Lot {
  id             String    @id @default(cuid())
  order          Int       @default(0)
  name           String
  status         String    @default("ACTIVE")
  startDate      DateTime  @default(now())
  actualEndDate  DateTime?
  plannedEndDate DateTime?
  initialChicks  Int
  initialAge     Int
  currentAge     Int

  // Relations
  batimentId String
  batiment   Batiment @relation(fields: [batimentId], references: [id], onDelete: Cascade)

  // 1 Lot -> N LotEvent
  events LotEvent[]

  // Metadata
  createdById String
  createdBy   User     @relation("LotCreator", fields: [createdById], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([batimentId])
  @@index([status])
  @@index([startDate])
  @@map("lots")
}

model LotEvent {
  id        String @id @default(cuid())
  order     Int    @default(0)
  eventType String // dc | cost | revenue

  deadCount   Int?
  costfood    Float?
  revenueSale Float?

  // Relation to Lot (optional in your original intent? Here: required)
  lotId String
  lot   Lot    @relation(fields: [lotId], references: [id], onDelete: Cascade)

  // Metadata
  createdById String
  createdBy   User     @relation("LotEventCreator", fields: [createdById], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([lotId])
  @@index([createdById])
  @@map("lot_events")
}

///////////////////////
/////   Setting   /////
///////////////////////
model Setting {
  id     String @id @default(cuid())
  teamId String @unique

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  // Coûts d'alimentation (par kg)
  costAlimStarter Float
  costAlimGrower  Float
  costAlimPreLay  Float
  costAlimLayer   Float

  // Prix de vente des œufs (par œuf)
  salePriceEggS  Float
  salePriceEggM  Float
  salePriceEggL  Float
  salePriceEggXL Float

  // Prix de vente des poules (par kg)
  salePriceLayKg    Float
  salePriceBoilerKg Float

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("settings")
}

//////////////////////////
/////   Calendrier   /////
//////////////////////////
model CalendarEvent {
  id          String    @id @default(cuid())
  title       String
  description String?
  startDate   DateTime
  endDate     DateTime?
  teamId      String

  // Relations
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  // Metadata
  createdById String
  createdBy   User     @relation("CalendarEventCreator", fields: [createdById], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([teamId])
  @@index([startDate])
  @@index([createdById])
  @@map("events")
}
