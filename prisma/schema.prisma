// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

///////////////////////////////////
/////  Modèles Better-Auth   ////// 
///////////////////////////////////

model User {
  id               String   @id @default(cuid())
  name             String?
  email            String   @unique
  emailVerified    Boolean  @default(false)
  image            String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  twoFactorEnabled Boolean  @default(false)

  // Auth relations
  sessions Session[]
  accounts Account[]

  // Business relations
  ownedTeams Team[]     @relation("TeamOwner")
  userTeams  UserTeam[]

  createdItems          Item[]           @relation("ItemCreatedBy")
  createdEquipements    Equipement[]     @relation("EquipementCreatedBy")
  createdLots           Lot[]            @relation("LotCreatedBy")
  createdPhases         Phase[]          @relation("PhaseCreatedBy")
  createdEvents         Event[]          @relation("EventCreatedBy")
  createdTasks          Tasks[]          @relation("TaskCreatedBy")
  createdBreedingParams BreedingParams[] @relation("BreedingParamsCreatedBy")
  createdSettings       Setting[]        @relation("SettingCreatedBy")
  items                 Item[]
  equipements           Equipement[]
  phases                Phase[]
  events                Event[]
  tasks                 Tasks[]
  breedingParams        BreedingParams[]
  lots                  Lot[]
  settings              Setting[]

  @@index([email])
  @@index([createdAt])
  @@map("users")
}

model Session {
  id        String   @id @default(cuid())
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model Account {
  id                    String    @id @default(cuid())
  accountId             String
  providerId            String
  userId                String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("accounts")
}

model VerificationToken {
  id         String   @id @default(cuid())
  identifier String
  token      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([identifier, token])
  @@map("verification_tokens")
}

////////////////////////
///// ENUMS /////////
////////////////////////
enum SourceType {
  predicted
  observed
}

enum TeamType {
  ORGANIZATION
  TEAM
  FARM
}

//////////////////
/////   Dev  /////
//////////////////
model Item {
  id          String  @id @default(cuid())
  order       Int     @default(0)
  TypeItem    String  @default("")
  name        String
  description String?
  parentId    String?

  // Relations
  parent   Item?  @relation("ItemHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children Item[] @relation("ItemHierarchy")

  // Metadata
  createdById String
  createdBy   User     @relation("ItemCreatedBy", fields: [createdById], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users User[]

  @@index([parentId])
  @@index([createdById])
  @@map("items")
}

//////////////////////
//////   Teams   /////
//////////////////////
model Team {
  id       String   @id @default(cuid())
  order    Int      @default(0)
  name     String
  type     TeamType @default(TEAM)
  parentId String?

  // Relations
  parent    Team?      @relation("TeamHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children  Team[]     @relation("TeamHierarchy")
  members   UserTeam[]
  batiments Batiment[]
  setting   Setting?

  // Metadata
  ownerId   String
  owner     User     @relation("TeamOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([parentId])
  @@index([ownerId])
  @@index([type])
  @@map("teams")
}

model UserTeam {
  id     String @id @default(cuid())
  teamId String
  userId String
  role   String @default("member")

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  joinedAt DateTime @default(now())

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
  @@map("user_teams")
}

////////////////////////
//////   Farming   /////
////////////////////////
model Batiment {
  id       String @id @default(cuid())
  order    Int    @default(0)
  name     String
  surface  Float
  capacity Int
  teamId   String

  // Relations
  team        Team         @relation(fields: [teamId], references: [id], onDelete: Cascade)
  lots        Lot[]
  equipements Equipement[]

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teamId])
  @@map("batiments")
}

model Equipement {
  id                  String  @id @default(cuid())
  order               Int     @default(0)
  name                String
  description         String?
  legalNorms          String?
  maintenanceSchedule String?
  batimentId          String

  // Relations
  batiment Batiment @relation(fields: [batimentId], references: [id], onDelete: Cascade)

  // Metadata
  createdById String
  createdBy   User     @relation("EquipementCreatedBy", fields: [createdById], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users User[]

  @@index([batimentId])
  @@index([createdById])
  @@map("equipements")
}

/////////////////////////////////////////
//////   Breeding plannification   //////
/////////////////////////////////////////

model LifeCircle {
  id     String  @id @default(cuid())
  order  Int     @default(0)
  type   String
  phases Phase[]
}

model Phase {
  id             String           @id @default(cuid())
  order          Int              @default(0)
  name           String
  weekStart      DateTime
  weekEnd        DateTime
  events         Event[]
  tasks          Tasks[]
  breedingParams BreedingParams[]
  lifeCircleId   String
  lifeCircle     LifeCircle       @relation(fields: [lifeCircleId], references: [id], onDelete: Cascade)

  // Metadata
  createdById String
  createdBy   User     @relation("PhaseCreatedBy", fields: [createdById], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users User[]
}

model Event {
  id           String     @id @default(cuid())
  source       SourceType @default(predicted)
  predictedId  String?
  predicted    Event?     @relation("EventPrediction", fields: [predictedId], references: [id])
  observations Event[]    @relation("EventPrediction")

  order       Int      @default(0)
  name        String
  day         DateTime
  currentAge  Int
  Cheptel     Int
  weightGrams Int
  feedAmount  Json
  nbEggs      Int
  nbeggS      Int
  nbeggM      Int
  nbeggL      Int
  nbeggXL     Int

  phaseId String?
  phase   Phase?  @relation(fields: [phaseId], references: [id])

  lots Lot[]

  // Metadata
  createdById String
  createdBy   User     @relation("EventCreatedBy", fields: [createdById], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users User[]
}

model Tasks {
  id           String     @id @default(cuid())
  source       SourceType @default(predicted)
  predictedId  String?
  predicted    Tasks?     @relation("TaskPrediction", fields: [predictedId], references: [id])
  observations Tasks[]    @relation("TaskPrediction")

  order      Int      @default(0)
  name       String
  day        DateTime
  currentAge Int
  taskList   String[]

  phaseId String?
  phase   Phase?  @relation(fields: [phaseId], references: [id])

  lots Lot[]

  // Metadata
  createdById String
  createdBy   User     @relation("TaskCreatedBy", fields: [createdById], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users User[]
}

model BreedingParams {
  id           String           @id @default(cuid())
  source       SourceType       @default(predicted)
  predictedId  String?
  predicted    BreedingParams?  @relation("BreedingParamsPrediction", fields: [predictedId], references: [id])
  observations BreedingParams[] @relation("BreedingParamsPrediction")

  order          Int      @default(0)
  day            DateTime
  currentAge     Int
  temperature    String
  humidity       String
  lightHours     String
  lightIntensity String

  phaseId String?
  phase   Phase?  @relation(fields: [phaseId], references: [id])

  lots Lot[]

  // Metadata
  createdById String
  createdBy   User     @relation("BreedingParamsCreatedBy", fields: [createdById], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users User[]
}

///////////////////////
/////   Breeding   ////
///////////////////////
model Lot {
  id             String           @id @default(cuid())
  order          Int              @default(0)
  name           String
  status         String           @default("ACTIVE")
  startDate      DateTime         @default(now())
  actualEndDate  DateTime?
  plannedEndDate DateTime?
  initialChicks  Int
  initialAge     Int
  batimentId     String
  batiment       Batiment         @relation(fields: [batimentId], references: [id], onDelete: Cascade)
  events         Event[]
  tasks          Tasks[]
  breedingParams BreedingParams[]

  // Metadata
  createdById String
  createdBy   User     @relation("LotCreatedBy", fields: [createdById], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users User[]

  @@unique([batimentId, name])
  @@index([batimentId])
  @@index([status])
  @@index([startDate])
  @@map("lots")
}

///////////////////////
/////   Setting   /////
///////////////////////
model Setting {
  id     String @id @default(cuid())
  teamId String @unique

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  // Coûts d'alimentation (par kg)
  costAlimStarter Float
  costAlimGrower  Float
  costAlimPreLay  Float
  costAlimLayer   Float

  // Prix de vente des œufs (par œuf)
  salePriceEggS  Float
  salePriceEggM  Float
  salePriceEggL  Float
  salePriceEggXL Float

  // Prix de vente des poules (par kg)
  salePriceLayKg    Float
  salePriceBoilerKg Float

  // Metadata
  createdById String
  createdBy   User     @relation("SettingCreatedBy", fields: [createdById], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users User[]

  @@map("settings")
}

//////////////////////////
/////   Calendrier   /////
//////////////////////////
model Calendar {
  id          String   @id @default(cuid())
  date        DateTime
  title       String
  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
